# 가족 약 복용 안전 관리 서비스 — Cursor Rules (Single)
목표: Cursor가 개발 중 **기획/아키텍처/UX 원칙을 자동으로 준수**하게 한다. (근거 문서: `기획안.md`, `code-architecture.md`, `design-guide.md`, `wireframe.md`)

## 1) Project North Star (절대 바꾸지 말 것)
- 한 줄 정의: 가족 구성원이 질병/진단 정보는 공유하지 않고, 복용 중인 약의 **성분·주의사항만 선택적으로 공유**하여 **중복 복용·상호작용 가능성**을 빠르게 확인하는 서비스
- 제품 성격: **정보 제공형(Info-only)**, 의료 판단/처방/진단 금지
- MVP 핵심 플로우: **대신 약 사주기(Quick Check)** → 10~20초 내 결과(상태+근거+다음 행동)

## 2) Non-negotiables (필수 준수)
### ✅ 반드시 해야 함
- **Info-only**: 결과는 “가능성” 안내 + “근거” + “약사/의사 문의” CTA만 제공
- **Opt-in 공유**: 기본 비공개. 공유/철회는 사용자 동의 기반
- **최소 데이터**: 실명/병명/진단/복용 목적 수집·저장·로그 금지(닉네임 중심)
- **확인불가 처리**: 데이터 불충분 시 확정/추정 금지, “확인불가”로 강등 + 행동 가이드
- **근거/출처/갱신일**: 약 상세/결과 화면에 항상 표기
- **안전 고지 고정 노출**: “의료 조언 아님 + 복용/구매 전 약사·의사 상담”을 결과 화면에 고정

### ❌ 절대 하지 말 것
- “안전합니다/문제없습니다/절대 복용하지 마세요” 같은 **판정/확정/명령형 의료 카피**
- 병명/진단/처방 사유 입력 UI, DB 컬럼, 로그/분석 이벤트 추가
- 공유되지 않은 약의 **존재 여부 노출**(리스트/검색/카운트/오류 응답 포함)

## 3) 기술 스택 고정(원칙: 일관성)
- Web: Next.js(App Router) + React + TypeScript
- UI: Tailwind CSS + shadcn/ui, 모바일 우선, PWA 고려
- Data: Postgres + Prisma, 입력 검증은 zod
- Auth: 이메일 매직링크(next-auth/Auth.js 계열)
- Deploy: Vercel, Node 22.x 고정

## 4) 아키텍처/폴더 구조(권장 + 강제 경계)
- UI: `src/components/**`
- 도메인(프론트): `src/features/**`
- 서버 로직: `src/server/**`
  - **권한 판단은 `src/server/permissions/**`로만** (분산 금지)
  - 서비스 로직은 `src/server/services/**`
- API: `src/app/api/**` (Route Handler는 입력검증/세션확인/응답만)

## 5) 권한/보안(가장 중요)
### ✅ 구현 규칙
- **존재 비노출(쿼리 레벨)**:
  - 타인 약 데이터는 반드시 `MedicationShare` 중심으로만 조회/카운트/검색
  - “그 사람이 가진 약 전체 조회 후 필터링” 패턴 금지(메타 누출)
- **권한 없음은 기본 404**(403보다 404 우선)로 “없는 것처럼” 응답
- **초대 링크 토큰**: 랜덤 생성 → **해시만 DB 저장**, TTL/재발급/철회 지원
- **감사 로그(권장)**: 타인 공유 약 조회 시 최소 필드로 기록(viewer, target, action, timestamp)

### ❌ 금지 패턴
- 그룹 전체 약 목록 조회 API/쿼리(공유 매핑 없이)
- 공유되지 않은 약에 대한 403 반환(존재 유추 가능)

## 6) 도메인 규칙(Quick Check/상태)
- 결과 상태는 **3단계만 사용(고정)**:
  - `주의 필요`
  - `현재 정보로 큰 이슈 없음`
  - `확인불가`
- 결과 화면 구성은 항상 **상태 + 근거 + 다음 행동(약사 문의)** 3요소
- “확인불가” 트리거 예:
  - 입력 약의 성분을 확정할 수 없음(데이터 미포함/비표준/사용자 입력)
  - 비교 범위가 불충분해 결론을 낼 수 없음(권한/데이터 부족)

## 7) 데이터/출처/라이선스
- 출처 우선순위(국내):
  - 1) 식약처 의약품안전나라
  - 2) 공공데이터포털/공공기관 데이터
  - 3) 사용자 입력(“검증 전/확인불가” 라벨 필수)
- 라이선스/이용범위가 불확실하면 기능은 **확인불가 처리 + 약사 문의 UX**로 우회
- 약 상세/결과에 `출처`, `갱신일`, `확인가능범위`를 항상 표시

## 8) UI/UX 규칙(간결하지만 강제)
- 화면당 Primary CTA는 **1개**(예: Quick Result의 “약사에게 질문하기”)
- 터치 타겟 최소 **44px**
- 상태 전달은 **색만으로 하지 말 것**(배지 텍스트 + 아이콘/설명 함께)
- Quick Check는 “매장 상황” 고려: 큰 글자/높은 대비/단계 최소화

## 9) 카피/문구(사용자 노출 텍스트)
### ✅ 필수 고지(짧은 버전)
- “본 서비스는 의료 조언이 아닌 참고 정보예요. 복용/구매 전 약사·의사와 상담하세요.”

### ✅ ‘약사에게 질문하기’ 템플릿(재사용)
- “현재 **○○ 성분/약**을 복용 중인데, 이 약과 **같이 복용해도 되는지** 확인 부탁드려요.”

### ❌ 금지 표현
- “안전합니다”, “절대”, “문제 없습니다”, “복용하세요/하지 마세요” 같은 확정/판정 카피

## 10) 에이전트 작업 방식(이 프로젝트에서의 기본 행동)
- 변경 전에 관련 문서(`기획안.md`, `code-architecture.md`, `design-guide.md`, `wireframe.md`)와 규칙 충돌 여부를 확인
- 결정/가정이 필요하면 코드/PRD 관점에서 **짧게 명시**하고, 불확실하면 “확인불가” UX를 우선 적용
- 사용자-facing 텍스트는 **한국어**, 코드 식별자/경로/스키마는 **영문** 유지

